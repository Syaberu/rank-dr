<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeathRun Rankings</title>
    <script src="data.js"></script>
    <style>
        /* 参考サイトのシンプルかつクリーンなダークテーマを再現 */
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #ffffff;
            font-size: 2.2rem;
            margin: 20px 0 40px 0;
            letter-spacing: 2px;
        }

        /* タブメニュー（syaberu氏のスタイルを忠実に再現） */
        .tabs {
            display: flex;
            border-bottom: 1px solid #333;
            width: 100%;
            max-width: 950px;
            margin-bottom: 25px;
        }

        .tab-btn {
            background: none;
            border: none;
            color: #777;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab-btn:hover {
            color: #bbb;
        }

        .tab-btn.active {
            color: #00e5ff;
            border-bottom: 2px solid #00e5ff;
        }

        /* ランキングテーブル */
        .ranking-table {
            width: 100%;
            max-width: 950px;
            border-collapse: collapse;
            background-color: #1a1a1a;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .ranking-table thead {
            background-color: #252525;
        }

        .ranking-table th {
            padding: 12px 15px;
            text-align: left;
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #333;
        }

        .ranking-table td {
            padding: 14px 15px;
            border-bottom: 1px solid #282828;
            vertical-align: middle;
        }

        .ranking-table tr:hover {
            background-color: #222;
        }

        /* 各列のスタイル */
        .rank-col { width: 50px; text-align: center; font-weight: bold; font-size: 1.2rem; color: #555; }
        .skin-col { width: 50px; text-align: center; }
        .name-col { font-weight: 600; font-size: 1.05rem; color: #fff; }
        .tier-col { width: 110px; text-align: center; }
        .record-col { width: 140px; text-align: right; font-family: 'Consolas', monospace; color: #00e5ff; font-weight: bold; }
        .rating-col { width: 100px; text-align: right; color: #666; font-size: 0.85rem; }

        /* スキンヘッド画像 (skinsフォルダ参照) */
        .skin-img {
            width: 34px;
            height: 34px;
            image-rendering: pixelated;
            border-radius: 3px;
            background-color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Tierバッジ */
        .tier-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 800;
            display: inline-block;
            min-width: 50px;
        }
        .tier-ht { background-color: #ff3d00; color: #fff; } /* 鮮やかな赤 */
        .tier-lt { background-color: #00c853; color: #fff; } /* 鮮やかな緑 */
        .tier-none { background-color: #424242; color: #bbb; }

        /* 1-3位のカラーアクセント */
        tr:nth-child(1) .rank-col { color: #ffca28; }
        tr:nth-child(2) .rank-col { color: #cfd8dc; }
        tr:nth-child(3) .rank-col { color: #bcaaa4; }

        @keyframes fadeInRow {
            from { opacity: 0; transform: translateX(-5px); }
            to { opacity: 1; transform: translateX(0); }
        }
        tbody tr { animation: fadeInRow 0.3s ease-out forwards; }
    </style>
</head>
<body>

    <h1>DeathRun Rankings</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="updateMode('Overall', this)">Overall</button>
        <button class="tab-btn" onclick="updateMode('Cave', this)">Cave</button>
        <button class="tab-btn" onclick="updateMode('Temple', this)">Temple</button>
        <button class="tab-btn" onclick="updateMode('Factory', this)">Factory</button>
    </div>

    <table class="ranking-table">
        <thead>
            <tr>
                <th style="text-align: center;">Rank</th>
                <th>Skin</th>
                <th>Player Name</th>
                <th style="text-align: center;">Tier</th>
                <th style="text-align: right;">Record</th>
                <th style="text-align: right;">Rating</th>
            </tr>
        </thead>
        <tbody id="ranking-body">
            </tbody>
    </table>

    <script>
        let currentMode = 'Overall';

        function updateMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        function getTierIdx(tier) {
            if (!tier || tier === "-") return 999;
            const idx = TIER_ORDER.indexOf(tier);
            return idx === -1 ? 999 : idx;
        }

        function render() {
            const body = document.getElementById('ranking-body');
            body.innerHTML = '';

            let sorted = [...players];

            sorted.sort((a, b) => {
                if (currentMode === 'Overall') {
                    // Overall: 全マップの合計タイム(record)が少ない順
                    const sumA = Object.values(a.mapTiers).reduce((acc, m) => acc + (m.record || 0), 0);
                    const sumB = Object.values(b.mapTiers).reduce((acc, m) => acc + (m.record || 0), 0);
                    if (sumA !== sumB) return sumA - sumB;
                    return b.rating - a.rating;
                } else {
                    // 各マップ: Tier優先 > タイム順 > Rating順
                    const mDataA = a.mapTiers[currentMode];
                    const mDataB = b.mapTiers[currentMode];
                    const tierA = typeof mDataA === 'string' ? mDataA : (mDataA ? mDataA.tier : "-");
                    const tierB = typeof mDataB === 'string' ? mDataB : (mDataB ? mDataB.tier : "-");
                    
                    const idxA = getTierIdx(tierA);
                    const idxB = getTierIdx(tierB);
                    if (idxA !== idxB) return idxA - idxB;

                    const recA = typeof mDataA === 'string' ? 999.999 : (mDataA ? mDataA.record : 999.999);
                    const recB = typeof mDataB === 'string' ? 999.999 : (mDataB ? mDataB.record : 999.999);
                    if (recA !== recB) return recA - recB;

                    return b.rating - a.rating;
                }
            });

            sorted.forEach((p, i) => {
                const tr = document.createElement('tr');
                tr.style.animationDelay = (i * 0.03) + 's';
                
                let displayTier, displayRecord;
                if (currentMode === 'Overall') {
                    displayTier = p.tier;
                    const total = Object.values(p.mapTiers).reduce((acc, m) => acc + (m.record || 0), 0);
                    displayRecord = total > 0 ? total.toFixed(3) + "s" : "---";
                } else {
                    const mData = p.mapTiers[currentMode];
                    displayTier = (mData && typeof mData === 'object') ? mData.tier : (mData || "-");
                    const rec = (mData && typeof mData === 'object') ? mData.record : 0;
                    displayRecord = rec > 0 ? rec.toFixed(3) + "s" : "---";
                }

                const tierClass = displayTier.startsWith("HT") ? "tier-ht" : (displayTier.startsWith("LT") ? "tier-lt" : "tier-none");
                
                // 画像フォルダ名を skins に修正
                const imgPath = `skins/${p.name}.png`;

                tr.innerHTML = `
                    <td class="rank-col">${i + 1}</td>
                    <td class="skin-col"><img src="${imgPath}" class="skin-img" onerror="this.src='skins/default.png'"></td>
                    <td class="name-col">${p.name}</td>
                    <td class="tier-col"><span class="tier-badge ${tierClass}">${displayTier}</span></td>
                    <td class="record-col">${displayRecord}</td>
                    <td class="rating-col">R: ${p.rating}</td>
                `;
                body.appendChild(tr);
            });
        }

        window.onload = render;
    </script>
</body>
</html>
